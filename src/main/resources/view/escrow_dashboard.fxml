<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.shape.Circle?>
<?import javafx.scene.shape.SVGPath?>
<?import javafx.scene.effect.DropShadow?>
<?import javafx.scene.image.ImageView?>

<StackPane xmlns:fx="http://javafx.com/fxml"
           fx:controller="tn.finhub.controller.EscrowController"
           style="-fx-padding: 40; -fx-background-color: transparent;">

    <!-- MAIN DASHBOARD VIEW -->
    <VBox fx:id="mainView" spacing="25">
        <!-- Header Section -->
        <!-- Header Section (AnchorPane for stable centering) -->
        <AnchorPane>
            <!-- Left: Title -->
            <VBox AnchorPane.leftAnchor="0.0" AnchorPane.topAnchor="0.0" AnchorPane.bottomAnchor="0.0" alignment="CENTER_LEFT">
                <Label text="%escrow.title" styleClass="header-text" style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: -color-text-primary;"/>
                <Label text="%escrow.subtitle" styleClass="sub-header-text" style="-fx-text-fill: -color-text-secondary; -fx-font-size: 14px;"/>
            </VBox>

            <!-- Center: Trust Score (Absolute Center) -->
            <StackPane AnchorPane.leftAnchor="0.0" AnchorPane.rightAnchor="0.0" AnchorPane.topAnchor="0.0" AnchorPane.bottomAnchor="0.0" alignment="CENTER" mouseTransparent="true">
                <HBox alignment="CENTER" spacing="15" maxWidth="-Infinity" style="-fx-background-color: -color-card-bg; -fx-background-radius: 12; -fx-padding: 10 20; -fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.1), 5, 0, 0, 0);" mouseTransparent="false">
                    <VBox alignment="CENTER_LEFT">
                        <Label text="%escrow.trust.score" style="-fx-font-size: 12px; -fx-text-fill: -color-text-muted;"/>
                        <Label fx:id="trustScoreLabel" text="100" style="-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: -color-primary;"/>
                    </VBox>
                    <StackPane>
                        <Circle radius="22" style="-fx-fill: transparent; -fx-stroke: -color-bg; -fx-stroke-width: 4;"/>
                        <Circle fx:id="trustScoreCircle" radius="22" style="-fx-fill: transparent; -fx-stroke: -color-primary; -fx-stroke-width: 4; -fx-stroke-dash-array: 0 1000;"/>
                        <SVGPath fx:id="trustScoreIcon" content="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" scaleX="0.8" scaleY="0.8" style="-fx-fill: -color-primary;"/>
                    </StackPane>
                </HBox>
            </StackPane>

            <!-- Right: Actions -->
            <HBox AnchorPane.rightAnchor="0.0" AnchorPane.topAnchor="0.0" AnchorPane.bottomAnchor="0.0" alignment="CENTER_RIGHT" spacing="15">
                <Button fx:id="addContactBtn" text="Add Contact" onAction="#handleShowAddContactView" visible="false" managed="false" styleClass="button-primary" style="-fx-font-size: 14px; -fx-padding: 12 24; -fx-background-radius: 8; -fx-cursor: hand; -fx-background-color: -color-secondary;">
                     <graphic>
                        <SVGPath content="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" style="-fx-fill: white;"/>
                     </graphic>
                </Button>

                <Button fx:id="createEscrowBtn" text="%escrow.create.button" onAction="#handleCreateEscrow" styleClass="button-primary" style="-fx-font-size: 14px; -fx-padding: 12 24; -fx-background-radius: 8; -fx-cursor: hand;">
                     <graphic>
                        <SVGPath content="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" style="-fx-fill: white;"/>
                     </graphic>
                </Button>
            </HBox>
        </AnchorPane>


        <!-- Filters / Tabs -->
        <HBox spacing="15">
            <Button fx:id="btnContacts" text="Contacts" onAction="#handleFilterContacts" styleClass="filter-button"/>
            <Button fx:id="btnActive" text="%escrow.filter.active" onAction="#handleFilterActive" styleClass="filter-button"/>
            <Button fx:id="btnHistory" text="%escrow.filter.history" onAction="#handleFilterHistory" styleClass="filter-button"/>
            <Button fx:id="btnDisputes" text="%escrow.filter.disputes" onAction="#handleFilterDisputes" styleClass="filter-button"/>
        </HBox>

        <StackPane VBox.vgrow="ALWAYS">
            <!-- Escrow List (Styled) -->
            <ScrollPane fx:id="escrowScrollPane" fitToWidth="true" style="-fx-background: transparent; -fx-background-color: transparent;" VBox.vgrow="ALWAYS">
                <VBox fx:id="escrowCardContainer" spacing="15" style="-fx-background-color: transparent;">
                     <!-- Cards will be injected here by Controller -->
                     <Label text="%common.loading" style="-fx-text-fill: -color-text-muted; -fx-padding: 20;"/>
                </VBox>
            </ScrollPane>
            
            <!-- Contact List (Grid/Flow) -->
            <ScrollPane fx:id="contactsScrollPane" fitToWidth="true" visible="false" style="-fx-background: transparent; -fx-background-color: transparent;" VBox.vgrow="ALWAYS">
                 <javafx.scene.layout.FlowPane fx:id="contactsContainer" hgap="20" vgap="20" style="-fx-padding: 10;">
                     <!-- Contact Cards go here -->
                 </javafx.scene.layout.FlowPane>
            </ScrollPane>
        </StackPane>
    </VBox>

    <!-- CONTACT DETAILS VIEW (Full Page) -->
    <VBox fx:id="contactDetailsView" visible="false" spacing="20" style="-fx-background-color: transparent;">
        <HBox alignment="CENTER_LEFT" spacing="15">
            <Button onAction="#handleBackToMain" style="-fx-background-color: transparent; -fx-cursor: hand;">
                <graphic>
                    <SVGPath content="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" style="-fx-fill: -color-text-primary;"/>
                </graphic>
            </Button>
            <Label text="Contact Details" style="-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: -color-text-primary;"/>
        </HBox>

        <HBox spacing="30" alignment="TOP_LEFT" VBox.vgrow="ALWAYS">
            <!-- Left Panel: Profile Info (Glassmorphism) -->
            <VBox minWidth="380" maxWidth="380" spacing="0" alignment="TOP_CENTER"
                  style="-fx-background-color: rgba(30, 20, 60, 0.55); -fx-background-radius: 20; -fx-border-color: rgba(139, 92, 246, 0.2); -fx-border-radius: 20; -fx-border-width: 1; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 15, 0, 0, 4);">

                <!-- Top: Avatar + Name -->
                <VBox alignment="CENTER" spacing="10" style="-fx-padding: 30 30 20 30;">
                    <StackPane>
                         <Circle radius="55" style="-fx-fill: rgba(139, 92, 246, 0.08); -fx-stroke: transparent;"/>
                         <Label fx:id="overlayInitials" text="SN" style="-fx-font-size: 36px; -fx-font-weight: bold; -fx-text-fill: -color-primary;"/>
                         <ImageView fx:id="overlayImage" fitHeight="110" fitWidth="110" preserveRatio="true">
                            <clip>
                                <Circle radius="55" centerX="55" centerY="55"/>
                            </clip>
                         </ImageView>
                         <Circle radius="55" style="-fx-fill: transparent; -fx-stroke: -color-primary; -fx-stroke-width: 2.5;" mouseTransparent="true"/>
                    </StackPane>

                    <HBox alignment="CENTER" spacing="8">
                        <Label fx:id="overlayName" text="User Name" style="-fx-font-size: 22px; -fx-font-weight: bold; -fx-text-fill: white;"/>
                        <Button onAction="#handleEditAlias" style="-fx-background-color: transparent; -fx-cursor: hand; -fx-padding: 4;">
                             <graphic>
                                <SVGPath content="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" style="-fx-fill: rgba(139, 92, 246, 0.6);" scaleX="0.7" scaleY="0.7"/>
                             </graphic>
                             <tooltip><Tooltip text="Edit Name / Add Alias"/></tooltip>
                        </Button>
                    </HBox>

                    <!-- Alias Edit Field (Hidden initially) -->
                    <HBox fx:id="aliasEditBox" visible="false" managed="false" alignment="CENTER" spacing="5">
                        <TextField fx:id="aliasField" promptText="Enter alias" styleClass="text-field"/>
                        <Button text="Save" onAction="#handleSaveAlias" styleClass="button-primary" style="-fx-padding: 5 10; -fx-font-size: 12px;"/>
                        <Button text="Cancel" onAction="#handleCancelEditAlias" styleClass="button-secondary" style="-fx-padding: 5 10; -fx-font-size: 12px;"/>
                    </HBox>
                </VBox>

                <!-- Divider -->
                <Region style="-fx-background-color: rgba(139, 92, 246, 0.15); -fx-pref-height: 1; -fx-max-height: 1;" maxWidth="Infinity">
                    <padding><Insets left="25" right="25"/></padding>
                </Region>

                <!-- Middle: Info Rows -->
                <VBox spacing="14" style="-fx-padding: 20 30;">
                    <!-- Email Row -->
                    <HBox spacing="12" alignment="CENTER_LEFT">
                        <StackPane prefWidth="28" prefHeight="28" minWidth="28" minHeight="28" maxWidth="28" maxHeight="28"
                                   style="-fx-background-color: rgba(139, 92, 246, 0.12); -fx-background-radius: 8;">
                            <SVGPath content="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"
                                     style="-fx-fill: #8b5cf6;" scaleX="0.6" scaleY="0.6"/>
                        </StackPane>
                        <VBox spacing="1">
                            <Label text="Email" style="-fx-font-size: 10px; -fx-text-fill: rgba(255,255,255,0.4); -fx-font-weight: bold;"/>
                            <Label fx:id="overlayEmail" text="user@email.com" style="-fx-text-fill: rgba(255,255,255,0.85); -fx-font-size: 13px;"/>
                        </VBox>
                    </HBox>
                    <!-- Phone Row -->
                    <HBox spacing="12" alignment="CENTER_LEFT">
                        <StackPane prefWidth="28" prefHeight="28" minWidth="28" minHeight="28" maxWidth="28" maxHeight="28"
                                   style="-fx-background-color: rgba(139, 92, 246, 0.12); -fx-background-radius: 8;">
                            <SVGPath content="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"
                                     style="-fx-fill: #8b5cf6;" scaleX="0.6" scaleY="0.6"/>
                        </StackPane>
                        <VBox spacing="1">
                            <Label text="Phone" style="-fx-font-size: 10px; -fx-text-fill: rgba(255,255,255,0.4); -fx-font-weight: bold;"/>
                            <Label fx:id="overlayPhone" text="+216 00 000 000" style="-fx-text-fill: rgba(255,255,255,0.85); -fx-font-size: 13px;"/>
                        </VBox>
                    </HBox>
                </VBox>

                <!-- Divider -->
                <Region style="-fx-background-color: rgba(139, 92, 246, 0.15); -fx-pref-height: 1; -fx-max-height: 1;" maxWidth="Infinity">
                    <padding><Insets left="25" right="25"/></padding>
                </Region>

                <!-- Trust Score + Wallet Status Badges -->
                <HBox spacing="20" alignment="CENTER" style="-fx-padding: 18 30;">
                     <VBox alignment="CENTER" spacing="4" style="-fx-background-color: rgba(16, 185, 129, 0.08); -fx-background-radius: 12; -fx-padding: 12 20;" HBox.hgrow="ALWAYS">
                         <HBox alignment="CENTER" spacing="6">
                             <SVGPath content="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" style="-fx-fill: #10b981;" scaleX="0.65" scaleY="0.65"/>
                             <Label text="Trust Score" style="-fx-font-size: 11px; -fx-text-fill: rgba(255,255,255,0.5); -fx-font-weight: bold;"/>
                         </HBox>
                         <Label fx:id="overlayTrustScore" text="100" style="-fx-font-size: 26px; -fx-font-weight: bold; -fx-text-fill: -color-success;"/>
                     </VBox>
                     <VBox alignment="CENTER" spacing="4" style="-fx-background-color: rgba(139, 92, 246, 0.08); -fx-background-radius: 12; -fx-padding: 12 20;" HBox.hgrow="ALWAYS">
                         <HBox alignment="CENTER" spacing="6">
                             <SVGPath content="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z" style="-fx-fill: #8b5cf6;" scaleX="0.65" scaleY="0.65"/>
                             <Label text="Wallet" style="-fx-font-size: 11px; -fx-text-fill: rgba(255,255,255,0.5); -fx-font-weight: bold;"/>
                         </HBox>
                         <Label fx:id="overlayWalletStatus" text="ACTIVE" style="-fx-font-size: 16px; -fx-font-weight: bold; -fx-text-fill: -color-success;"/>
                     </VBox>
                </HBox>

                <Region VBox.vgrow="ALWAYS"/>

                <!-- Action Buttons -->
                <VBox spacing="10" style="-fx-padding: 0 25 25 25;" maxWidth="Infinity">
                    <Button text="New Escrow Transaction" onAction="#handleCreateEscrowFromContact" styleClass="button-primary" maxWidth="Infinity" style="-fx-padding: 12; -fx-background-radius: 10;"/>
                    <Button text="Remove from Contacts" onAction="#handleDeleteContact" styleClass="button-danger-outline" maxWidth="Infinity" style="-fx-background-radius: 10;">
                         <graphic>
                            <SVGPath content="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" style="-fx-fill: -color-error;"/>
                         </graphic>
                    </Button>
                </VBox>
            </VBox>

            <!-- Right Panel: Contact History -->
             <VBox HBox.hgrow="ALWAYS" spacing="15">
                <Label text="Recent Activity with Contact" style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: -color-text-primary;"/>
                <VBox fx:id="contactActivityContainer" spacing="10">
                     <Label fx:id="noActivityLabel" text="No recent transactions." style="-fx-text-fill: -color-text-muted;"/>
                </VBox>
            </VBox>
        </HBox>
    </VBox>

</StackPane>
