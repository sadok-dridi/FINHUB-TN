<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.shape.SVGPath?>
<?import javafx.scene.chart.*?>
<?import javafx.geometry.Insets?>

<VBox xmlns:fx="http://javafx.com/fxml" fx:controller="tn.finhub.controller.FinancialTwinController"
      spacing="20" style="-fx-padding: 30; -fx-background-color: transparent;" 
      stylesheets="@../style/theme.css">
        
            <!-- Header Section -->
            <VBox spacing="5">
                <Label text="Financial Twin &amp; Market Simulation" styleClass="header-text"/>
                <Label text="Analyze your financial health and practice trading with AI assistance." 
                       styleClass="sub-header-text"/>
            </VBox>

            <TabPane styleClass="modern-tab-pane" tabClosingPolicy="UNAVAILABLE">
                
                <!-- TAB 1: Financial Health (Existing) -->
                <Tab text="Financial Health">
                    <VBox spacing="20" style="-fx-padding: 20 0 0 0;">
                        <HBox spacing="20" VBox.vgrow="ALWAYS">
                            <!-- LEFT COL: Inputs & Score (Fixed Width) -->
                            <VBox spacing="20" HBox.hgrow="NEVER" minWidth="360" maxWidth="360">
                                
                                <!-- What-if Scenarios Card -->
                                <VBox styleClass="card" spacing="15">
                                    <Label text="What-If Scenarios" styleClass="section-label" style="-fx-font-size: 16px;"/>
                                    
                                    <VBox spacing="8">
                                        <Label text="Monthly Income (TND)" styleClass="label-bold" style="-fx-text-fill: -color-text-secondary;"/>
                                        <Slider fx:id="incomeSlider" min="0" max="10000" blockIncrement="100"/>
                                        <TextField fx:id="incomeField" styleClass="text-field" promptText="e.g. 3000"/>
                                    </VBox>
                    
                                    <VBox spacing="8">
                                        <Label text="Monthly Expenses (TND)" styleClass="label-bold" style="-fx-text-fill: -color-text-secondary;"/>
                                        <Slider fx:id="expenseSlider" min="0" max="10000" blockIncrement="100"/>
                                        <TextField fx:id="expenseField" styleClass="text-field" promptText="e.g. 2000"/>
                                    </VBox>
                                    
                                     <VBox spacing="8">
                                        <Label text="Savings Goal (TND)" styleClass="label-bold" style="-fx-text-fill: -color-text-secondary;"/>
                                        <TextField fx:id="goalField" styleClass="text-field" promptText="e.g. 10000"/>
                                    </VBox>
                                    
                                    <Button text="Run Simulation" styleClass="button-primary" onAction="#handleRunSimulation" maxWidth="Infinity"/>
                                    <Button text="Reset to Profile" styleClass="button-subtle" onAction="#handleReset" maxWidth="Infinity"/>
                                </VBox>
                    
                                 <!-- Health Score Card -->
                                <VBox styleClass="card" spacing="10" alignment="CENTER">
                                     <Label text="Financial Health Score" styleClass="section-label" style="-fx-font-size: 14px;"/>
                                     <StackPane>
                                        <ProgressIndicator fx:id="healthIndicator" progress="0.75" 
                                                          style="-fx-pref-width: 100; -fx-pref-height: 100; -fx-progress-color: -color-success;"/>
                                        <Label fx:id="healthScoreLabel" text="75" style="-fx-font-size: 24px; -fx-font-weight: bold;"/>
                                     </StackPane>
                                     <Label fx:id="healthStatusLabel" text="Healthy" style="-fx-font-weight: bold; -fx-text-fill: -color-success;"/>
                                </VBox>
                    
                            </VBox>
                    
                            <!-- RIGHT COL: Chart & Feedback (Flexible Width) -->
                            <VBox spacing="20" HBox.hgrow="ALWAYS">
                                
                                <!-- Chart Card (Takes top 50-60%) -->
                                <VBox styleClass="card" VBox.vgrow="ALWAYS" spacing="10" minHeight="350">
                                    <Label text="12-Month Projection" styleClass="section-label"/>
                                    <LineChart fx:id="projectionsChart" animated="false" createSymbols="false" legendVisible="false" VBox.vgrow="ALWAYS">
                                        <xAxis>
                                            <CategoryAxis label="Month"/>
                                        </xAxis>
                                        <yAxis>
                                            <NumberAxis label="Projected Savings (TND)"/>
                                        </yAxis>
                                    </LineChart>
                                </VBox>
                    
                                <!-- Insights Analysis (Takes remaining space, growing) -->
                                 <VBox styleClass="card" VBox.vgrow="ALWAYS" spacing="10" minHeight="200">
                                    <Label text="Twin Feedback" styleClass="section-label"/>
                                    <TextArea fx:id="insightsArea" editable="false" wrapText="true" 
                                              styleClass="text-area-readonly" VBox.vgrow="ALWAYS"
                                              style="-fx-background-color: transparent; -fx-text-fill: -color-text-secondary;"/>
                                </VBox>
                    
                            </VBox>
                        </HBox>
                    </VBox>
                </Tab>

                <!-- TAB 2: Market Simulator (Pro Design - Short & Compact) -->
                <Tab text="Market Simulator">
                    <HBox style="-fx-padding: 5 0 0 0;" spacing="6" alignment="TOP_CENTER">
                        <!-- Left: Asset List -->
                        <VBox styleClass="trading-sidebar" minWidth="160" maxWidth="180" maxHeight="450" spacing="0">
                            <Label text="Assets" styleClass="section-label" style="-fx-padding: 8; -fx-font-size: 11px;"/>
                            <ListView fx:id="assetListView" VBox.vgrow="ALWAYS" styleClass="asset-list-view"/>
                            <Button text="Refresh" styleClass="button-text-secondary" onAction="#handleRefreshMarket" maxWidth="Infinity" style="-fx-border-color: #2E2A45; -fx-border-width: 1 0 0 0; -fx-font-size: 10px; -fx-padding: 5;"/>
                        </VBox>

                        <!-- Center: Chart & Details -->
                        <VBox HBox.hgrow="ALWAYS" spacing="6" maxHeight="450">
                            <!-- Ticker Header -->
                            <HBox styleClass="trading-panel" alignment="CENTER_LEFT" spacing="10" style="-fx-padding: 8; -fx-background-radius: 6px;">
                                <HBox alignment="CENTER_LEFT" spacing="8">
                                    <Label fx:id="selectedAssetLabel" text="BTC" style="-fx-font-size: 16px; -fx-font-weight: 900; -fx-text-fill: white;"/>
                                </HBox>
                                <Separator orientation="VERTICAL"/>
                                <HBox alignment="CENTER_LEFT" spacing="4">
                                    <Label fx:id="selectedPriceLabel" text="--" style="-fx-font-size: 16px; -fx-font-family: 'Consolas'; -fx-text-fill: white;"/>
                                    <Label text="USD" style="-fx-text-fill: -color-text-secondary; -fx-font-size: 9px; -fx-padding: 4 0 0 0;"/>
                                </HBox>
                                <Label fx:id="selectedChangeLabel" text="" style="-fx-font-size: 11px; -fx-text-fill: -color-success;"/>
                                
                                <Region HBox.hgrow="ALWAYS"/>
                                
                                <!-- AI Insight Pill -->
                                <HBox fx:id="aiAdviceBox" alignment="CENTER_LEFT" style="-fx-background-color: rgba(139, 92, 246, 0.15); -fx-background-radius: 12px; -fx-padding: 2 8;" spacing="5" visible="false">
                                     <Label text="AI:" style="-fx-font-weight: bold; -fx-text-fill: -color-primary; -fx-font-size: 9px;"/>
                                     <Label fx:id="aiAdviceLabel" text="Hold" style="-fx-text-fill: white; -fx-font-size: 9px;"/>
                                </HBox>
                            </HBox>

                            <!-- Chart Area -->
                            <VBox styleClass="trading-panel" VBox.vgrow="ALWAYS" style="-fx-background-radius: 6px;">
                                <VBox fx:id="chartContainer" VBox.vgrow="ALWAYS" styleClass="market-chart-container" alignment="CENTER"/>
                            </VBox>
                        </VBox>

                        <!-- Right: Trading Panel -->
                        <VBox minWidth="200" maxWidth="210" maxHeight="450" spacing="6">
                            
                            <!-- Trade Execution Card -->
                            <VBox styleClass="trading-panel" style="-fx-background-radius: 6px; -fx-padding: 10;" spacing="10">
                                <Label text="Trade" styleClass="section-label" style="-fx-font-size: 11px;"/>
                                
                                <HBox spacing="5">
                                    <Button fx:id="btnBuy" text="BUY" styleClass="btn-buy-long" maxWidth="Infinity" HBox.hgrow="ALWAYS" onAction="#handleBuy" style="-fx-font-size: 11px; -fx-padding: 5;"/>
                                    <Button fx:id="btnSell" text="SELL" styleClass="btn-sell-short" maxWidth="Infinity" HBox.hgrow="ALWAYS" onAction="#handleSell" style="-fx-font-size: 11px; -fx-padding: 5;"/>
                                </HBox>

                                <VBox spacing="3" styleClass="trade-input-group">
                                    <Label text="Amount" styleClass="trade-label-small" style="-fx-font-size: 9px;"/>
                                    <HBox alignment="CENTER_LEFT">
                                        <TextField fx:id="quantityField" promptText="0.0" styleClass="trade-input-field" HBox.hgrow="ALWAYS" style="-fx-font-size: 11px;"/>
                                        <Label text="UNITS" style="-fx-text-fill: -color-text-muted; -fx-font-size: 8px; -fx-padding: 0 4;"/>
                                    </HBox>
                                </VBox>

                                <HBox alignment="CENTER_LEFT" spacing="5" style="-fx-padding: 2 0 0 0;">
                                    <Label text="Avail:" style="-fx-text-fill: -color-text-secondary; -fx-font-size: 9px;"/>
                                    <Region HBox.hgrow="ALWAYS"/>
                                    <Label text="25%" style="-fx-text-fill: -color-text-muted; -fx-font-size: 9px;"/>
                                </HBox>
                                
                                <Separator style="-fx-opacity: 0.1;"/>

                                <HBox alignment="CENTER_LEFT">
                                    <Label text="Est:" style="-fx-text-fill: -color-text-secondary; -fx-font-size: 10px;"/>
                                    <Region HBox.hgrow="ALWAYS"/>
                                    <Label fx:id="estCostLabel" text="0.00" style="-fx-font-weight: bold; -fx-text-fill: white; -fx-font-family: 'Consolas'; -fx-font-size: 11px;"/>
                                </HBox>
                            </VBox>

                            <!-- Position Summary -->
                            <VBox styleClass="trading-panel" VBox.vgrow="ALWAYS" style="-fx-background-radius: 6px; -fx-padding: 10;" spacing="8">
                                <Label text="Position" styleClass="section-label" style="-fx-font-size: 11px;"/>
                                
                                <GridPane hgap="5" vgap="5">
                                    <Label text="Owned" styleClass="trade-label-small" style="-fx-font-size: 9px;" GridPane.columnIndex="0" GridPane.rowIndex="0"/>
                                    <Label fx:id="ownedQuantityLabel" text="0" style="-fx-text-fill: white; -fx-font-weight: bold; -fx-font-size: 10px;" GridPane.columnIndex="1" GridPane.rowIndex="0"/>
                                    
                                    <Label text="Avg" styleClass="trade-label-small" style="-fx-font-size: 9px;" GridPane.columnIndex="0" GridPane.rowIndex="1"/>
                                    <Label fx:id="avgCostLabel" text="0.00" style="-fx-text-fill: white; -fx-font-size: 10px;" GridPane.columnIndex="1" GridPane.rowIndex="1"/>
                                </GridPane>

                                <Separator style="-fx-opacity: 0.1;"/>
                                
                                <VBox style="-fx-background-color: rgba(16, 185, 129, 0.1); -fx-background-radius: 6px; -fx-padding: 8;" spacing="1">
                                    <Label text="Wallet" style="-fx-text-fill: -color-success; -fx-font-size: 9px; -fx-font-weight: bold;"/>
                                    <Label fx:id="walletBalanceLabel" text="--" style="-fx-text-fill: white; -fx-font-size: 14px; -fx-font-weight: 900;"/>
                                </VBox>
                            </VBox>

                        </VBox>
                    </HBox>
                </Tab>

            </TabPane>
</VBox>
